<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Panel - Escencial Consultores</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --success: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; }
        
        .sidebar { width: 250px; height: 100vh; background: var(--primary); color: white; padding: 20px; position: fixed; display: flex; flex-direction: column; }
        .sidebar h2 { font-size: 1.2rem; border-bottom: 1px solid #ffffff33; padding-bottom: 10px; margin-bottom: 20px; }
        .nav-link { display: block; color: white; text-decoration: none; padding: 15px 0; transition: 0.3s; cursor: pointer; }
        .nav-link:hover { color: var(--secondary); }
        .logout-link { margin-top: auto; color: #fab1a0; border-top: 1px solid #ffffff33; padding-top: 20px; }

        .main-content { margin-left: 250px; padding: 40px; width: calc(100% - 250px); }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; border-top: 4px solid var(--secondary); }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9rem;}
        input, select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        
        .btn-ingresar { background-color: var(--secondary); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
        .btn-ingresar:hover { opacity: 0.9; }
        .btn-volver { background-color: #7f8c8d; width: auto; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-bottom: 20px;}

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        table th, table td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        table th { background: #f8f9fa; color: var(--primary); text-transform: uppercase; font-size: 0.75rem; }
        
        .badge-proceso { background: #e1f5fe; color: #0288d1; padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        
        .grid-container { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .oculto { display: none !important; }

        @media (max-width: 900px) { .grid-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="sidebar">
    <h2 id="nombre-sidebar">Consultor</h2>
    <nav>
        <a onclick="location.reload()" class="nav-link"><i class="fas fa-sync"></i> Actualizar Datos</a>
        <a onclick="volverInicio()" class="nav-link"><i class="fas fa-briefcase"></i> Mis Búsquedas</a>
    </nav>
    <a href="login_consultor.html" class="nav-link logout-link" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
</div>

<div class="main-content">
    
    <div id="vista-principal">
        <h1>Mi Espacio de Trabajo</h1>

        <div class="grid-container">
            
            <div class="card">
                <h3><i class="fas fa-user-plus"></i> Presentar Candidato</h3>
                <div class="form-group">
                    <label>DNI (Sin puntos)</label>
                    <input type="number" id="c-dni" placeholder="Ej: 35123456" required>
                </div>
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="c-nombre" placeholder="Nombre del postulante" required>
                </div>
                <div class="form-group">
                    <label>Vacante a la que aplica</label>
                    <select id="c-vacante">
                        <option value="">Cargando vacantes asignadas...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Link del CV (Drive/PDF)</label>
                    <input type="url" id="c-cv" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Link de Entrevista/Video</label>
                    <input type="url" id="c-video" placeholder="https://...">
                </div>
                <button onclick="cargarCandidato()" style="background: var(--success); color: white; font-weight: bold; margin-top: 10px;"><i class="fas fa-upload"></i> Subir Candidato</button>
            </div>

            <div class="card">
                <h3><i class="fas fa-briefcase"></i> Búsquedas Asignadas a mí</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Vacante</th>
                            <th>Provincia</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-mis-vacantes">
                        <tr><td colspan="3" style="text-align:center;">Buscando asignaciones...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="vista-detalle" class="oculto">
        <button onclick="volverInicio()" class="btn-volver"><i class="fas fa-arrow-left"></i> Volver al panel</button>

        <div class="card" style="border-left: 5px solid var(--secondary);">
            <h2 id="detalle-titulo" style="margin: 0; color: var(--primary);"><i class="fas fa-folder-open"></i> Vacante: -</h2>
        </div>

        <div class="card">
            <h3><i class="fas fa-users"></i> Mis Postulantes Presentados</h3>
            <table>
                <thead>
                    <tr>
                        <th>DNI</th>
                        <th>Nombre</th>
                        <th>Archivos</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="tabla-mis-candidatos">
                    </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-Q1S3S15loP-wlW2dcD1pZWPh4kmUyL-wUw5xJn50a836kR-Ca7-ufKv1-YtXSdA9/exec";
    
    // 1. Obtener identidad del consultor
    const MI_NOMBRE = localStorage.getItem('consultorNombre');
    let misVacantesData = [];

    window.onload = async () => {
        if (!MI_NOMBRE) {
            window.location.href = "login_consultor.html"; // Redirige si no está logueado
            return;
        }
        document.getElementById('nombre-sidebar').innerHTML = `<i class="fas fa-user-circle"></i> ${MI_NOMBRE}`;
        await cargarMisVacantes();
    };

    function cerrarSesion() {
        localStorage.removeItem('consultorNombre');
    }

    // --- CARGAR VACANTES ASIGNADAS AL CONSULTOR ---
    async function cargarMisVacantes() {
        try {
            const res = await fetch(SCRIPT_URL + "?type=getBusquedas");
            const data = await res.json();
            
            // Filtra vacantes activas que incluyan el nombre de este consultor
            misVacantesData = data.filter(v => v[5] === 'Activa' && v[6] && v[6].includes(MI_NOMBRE));
            
            const tbody = document.getElementById('tabla-mis-vacantes');
            const select = document.getElementById('c-vacante');
            
            tbody.innerHTML = "";
            select.innerHTML = '<option value="">Selecciona una vacante...</option>';

            if (misVacantesData.length === 0) {
                tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>No tienes búsquedas asignadas activas.</td></tr>";
                select.innerHTML = '<option value="">No hay vacantes asignadas</option>';
                return;
            }

            misVacantesData.forEach(v => {
                // v[1] = Puesto, v[4] = Provincia
                select.innerHTML += `<option value="${v[1]}">${v[1]} - ${v[4]}</option>`;
                
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:bold;">${v[1]}</td>
                        <td>${v[4]}</td>
                        <td style="text-align:right;">
                            <button class="btn-ingresar" onclick="ingresarCarpeta('${v[1]}')"><i class="fas fa-folder-open"></i> Ver Mis Postulantes</button>
                        </td>
                    </tr>`;
            });
        } catch (error) { console.error(error); }
    }

    // --- VERIFICAR Y CARGAR CANDIDATO ---
    async function cargarCandidato() {
        const dni = document.getElementById('c-dni').value;
        const nombre = document.getElementById('c-nombre').value;
        const puesto = document.getElementById('c-vacante').value;
        const cv = document.getElementById('c-cv').value;
        const video = document.getElementById('c-video').value;

        if (!dni || !nombre || !puesto) return alert("DNI, Nombre y Vacante son obligatorios.");

        // Buscar la provincia de la vacante seleccionada
        const vacanteSeleccionada = misVacantesData.find(v => v[1] === puesto);
        const provincia = vacanteSeleccionada ? vacanteSeleccionada[4] : "";

        // Cambiar botón a estado de carga
        const btn = document.querySelector('button[onclick="cargarCandidato()"]');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
        btn.disabled = true;

        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ 
                    type: 'CargarCandidato', 
                    dni: dni, 
                    nombre: nombre, 
                    puesto: puesto, 
                    consultor: MI_NOMBRE, 
                    cv: cv, 
                    video: video,
                    provincia: provincia 
                })
            });

            // Usamos un pequeño delay porque no-cors no nos deja leer la respuesta directamente,
            // pero sabemos que nuestro backend del Apps Script ya está manejando el rechazo de duplicados.
            // Para confirmarlo visualmente sin fallos:
            setTimeout(() => {
                alert("Petición procesada. (Si el DNI ya existía, el sistema lo bloqueó automáticamente).");
                location.reload();
            }, 1000);

        } catch (error) {
            alert("Error al conectar.");
            btn.innerHTML = '<i class="fas fa-upload"></i> Subir Candidato';
            btn.disabled = false;
        }
    }

    // --- CARPETA DE LA VACANTE (Ver postulantes propios) ---
    async function ingresarCarpeta(puesto) {
        document.getElementById('vista-principal').classList.add('oculto');
        document.getElementById('vista-detalle').classList.remove('oculto');
        document.getElementById('detalle-titulo').innerHTML = `<i class="fas fa-folder-open"></i> Vacante: ${puesto}`;
        
        const tbody = document.getElementById('tabla-mis-candidatos');
        tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'><i class='fas fa-spinner fa-spin'></i> Cargando tus postulantes...</td></tr>";

        try {
            const res = await fetch(SCRIPT_URL + "?type=getCandidatos");
            const data = await res.json();
            
            // Filtrar SOLO los candidatos de ESTE consultor para ESTA vacante
            const misCandidatos = data.filter(c => c[2] === puesto && c[3] === MI_NOMBRE);
            
            tbody.innerHTML = "";
            if (misCandidatos.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Aún no has presentado candidatos para esta búsqueda.</td></tr>";
                return;
            }

            misCandidatos.forEach(c => {
                tbody.innerHTML += `
                    <tr>
                        <td>${c[0]}</td>
                        <td style="font-weight:600;">${c[1]}</td>
                        <td>
                            <a href="${c[4]}" target="_blank" style="color:var(--secondary); text-decoration:none; margin-right:8px; font-weight:bold;"><i class="fas fa-file-pdf"></i> CV</a>
                            <a href="${c[5]}" target="_blank" style="color:var(--danger); text-decoration:none; font-weight:bold;"><i class="fas fa-video"></i> Link</a>
                        </td>
                        <td><span class="badge-proceso">${c[6] || 'En Revisión'}</span></td>
                    </tr>`;
            });
        } catch (error) { console.error(error); }
    }

    function volverInicio() {
        document.getElementById('vista-detalle').classList.add('oculto');
        document.getElementById('vista-principal').classList.remove('oculto');
    }
</script>

</body>
</html>